<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Family Mapping App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 90vh; width: 100vw; }
        .instructions {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 10px;
            background-color: rgba(255,255,255,0.9);
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            max-width: 300px;
        }
        .export-btn {
            position: absolute;
            top: 120px;
            right: 10px;
            z-index: 1000;
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: none;
        }
        .draw-mode {
            position: absolute;
            top: 170px;
            right: 10px;
            z-index: 1000;
            padding: 8px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="instructions">
        <strong>How to use:</strong><br>
        1. Click "Draw Circle Mode" to enable drawing<br>
        2. Click and drag to draw a circle<br>
        3. Click "Map Navigation" to move the map<br>
        4. Click export button to download CSV
    </div>
    <button class="export-btn" id="exportBtn" onclick="exportCircleSelection()">Export Addresses in Circle to CSV</button>
    <button class="draw-mode" id="drawModeBtn" onclick="toggleDrawMode()">Draw Circle Mode</button>
    <div id="map"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var addressData = {{ addresses_json|safe }};
        var currentCircle = null;
        var map = null;
        var isDrawing = false;
        var startPoint = null;
        var drawMode = false;
        
        // Initialize map
        map = L.map('map').setView([32.7767, -96.7970], 11);
        
        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        // Add markers
        addressData.forEach(function(addr) {
            L.marker([addr.Latitude, addr.Longitude])
                .bindPopup(addr['Family Name'] + '<br>' + addr.Address + '<br>' + addr.City + ', ' + addr.State + ' ' + addr.Zip)
                .addTo(map);
        });
        
        // Toggle between draw mode and navigation mode
        function toggleDrawMode() {
            drawMode = !drawMode;
            var btn = document.getElementById('drawModeBtn');
            if (drawMode) {
                btn.textContent = 'Map Navigation';
                btn.style.backgroundColor = '#dc3545'; // Red color
                map.getContainer().style.cursor = 'crosshair';
            } else {
                btn.textContent = 'Draw Circle Mode';
                btn.style.backgroundColor = '#007bff'; // Blue color
                map.getContainer().style.cursor = '';
                // If we were drawing, stop
                if (isDrawing) {
                    isDrawing = false;
                    startPoint = null;
                    map.dragging.enable();
                }
            }
        }
        
        // Mouse down - start drawing only if in draw mode
        map.on('mousedown', function(e) {
            if (!drawMode || e.originalEvent.button !== 0) return; // Early exit for performance
            
            isDrawing = true;
            startPoint = e.latlng;
            
            // Remove existing circle
            if (currentCircle) {
                map.removeLayer(currentCircle);
            }
            
            // Create initial circle with small radius for visibility
            currentCircle = L.circle(startPoint, {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.3,
                radius: 50
            }).addTo(map);
            
            // Prevent map dragging while drawing
            map.dragging.disable();
        });
        
        // Mouse move - update circle size (optimized)
        map.on('mousemove', function(e) {
            if (!isDrawing || !startPoint || !currentCircle) return; // Early exit for performance
            
            var radius = Math.max(50, map.distance(startPoint, e.latlng));
            currentCircle.setRadius(radius);
        });
        
        // Mouse up - finish drawing
        map.on('mouseup', function(e) {
            if (!isDrawing) return; // Early exit for performance
            
            isDrawing = false;
            
            // Final update to exact position
            if (startPoint && currentCircle) {
                var radius = Math.max(50, map.distance(startPoint, e.latlng));
                currentCircle.setRadius(radius);
            }
            
            startPoint = null;
            
            // Re-enable map dragging
            map.dragging.enable();
            
            // Always show export button since we have a minimum radius
            if (currentCircle) {
                document.getElementById('exportBtn').style.display = 'block';
            }
        });
        
        // Handle mouse leave to stop drawing
        map.on('mouseout', function(e) {
            if (!isDrawing) return; // Early exit for performance
            
            isDrawing = false;
            startPoint = null;
            map.dragging.enable();
            
            if (currentCircle) {
                document.getElementById('exportBtn').style.display = 'block';
            }
        });
        
        function exportCircleSelection() {
            if (!currentCircle) {
                alert('Please draw a circle on the map first!');
                return;
            }
            
            var center = currentCircle.getLatLng();
            var radius = currentCircle.getRadius();
            
            var selectedAddresses = [];
            addressData.forEach(function(addr) {
                var distance = map.distance(
                    [addr.Latitude, addr.Longitude],
                    [center.lat, center.lng]
                );
                if (distance <= radius) {
                    selectedAddresses.push(addr);
                }
            });
            
            if (selectedAddresses.length === 0) {
                alert('No addresses found within the circle!');
                return;
            }
            
            // Convert to CSV and download
            var csv = 'Family Name,Address,City,State,Zip,Latitude,Longitude\n';
            selectedAddresses.forEach(function(addr) {
                csv += '"' + (addr['Family Name'] || '').replace(/"/g, '""') + '","' + 
                       (addr.Address || '').replace(/"/g, '""') + '","' + 
                       (addr.City || '').replace(/"/g, '""') + '","' + 
                       (addr.State || '').replace(/"/g, '""') + '","' + 
                       (addr.Zip || '').replace(/"/g, '""') + '",' + 
                       addr.Latitude + ',' + addr.Longitude + '\n';
            });
            
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'selected_addresses.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Exported ' + selectedAddresses.length + ' addresses to CSV!');
        }
    </script>
</body>
</html> 